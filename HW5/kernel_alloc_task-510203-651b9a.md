# Задание: Модуль ядра Linux с аллокатором памяти на основе Bitmap

## Цель работы

Разработать модуль ядра Linux, который реализует **аллокатор памяти** с использованием **bitmap** для отслеживания занятых и свободных блоков памяти. Взаимодействие с модулем должно осуществляться через **модульные параметры** (`module_param_cb`).

Задание развивает навыки работы с:
- Управлением памятью в ядре Linux
- Структурой данных bitmap для отслеживания состояния ресурсов
- Алгоритмами поиска свободных блоков (first-fit)
- Механизмом модульных параметров с callback-функциями для взаимодействия с модулем
- Синхронизацией доступа к общей памяти (mutex/spinlock)

---

## Требования к реализации

### 1. Общие параметры аллокатора

- **Общий размер памяти**: 10 MiB (10485760 байт)
- **Размер одного блока**: 4 KiB (4096 байт)
- **Количество блоков**: 2560 блоков
- **Размер bitmap**: 2560 бит (320 байт)
- **Алгоритм поиска**: first-fit (поиск первого свободного блока)

#### 1.1 Основная структура аллокатора
Необходимо создать структуру для представления аллокатора:

```c
struct memory_allocator {
    unsigned char *bitmap;          /* Bitmap для отслеживания блоков (1 бит = 1 блок) */
    void *memory_pool;              /* Пул памяти для выделения */
    size_t total_blocks;            /* Общее количество блоков */
    size_t block_size;              /* Размер одного блока в байтах */
    spinlock_t lock;                /* Спинлок для синхронизации доступа */
};
```

#### 1.2 Структура дескриптора выделенной памяти
Каждое выделение памяти содержит информацию о количестве блоков:

```c
struct allocation_info {
    size_t start_block;             /* Индекс начального блока */
    size_t num_blocks;              /* Количество выделенных блоков */
};
```

### 2. Операции аллокатора

Реализовать следующие функции:

| Функция | Описание | Возвращаемое значение |
|---------|---------|----------------------|
| `allocator_init()` | Инициализация аллокатора и выделение памяти | int (0 - успех, -1 - ошибка) |
| `allocator_alloc(size_t bytes)` | Выделить блок памяти заданного размера | void* (адрес памяти или NULL при ошибке) |
| `allocator_free(void *ptr)` | Освободить блок памяти | int (0 - успех, -1 - ошибка) |
| `allocator_get_stats()` | Получить статистику аллокатора | struct stats_info |
| `allocator_cleanup()` | Очистить аллокатор и освободить память | void |

### 3. Структура статистики

```c
struct stats_info {
    size_t total_blocks;            /* Общее количество блоков */
    size_t free_blocks;             /* Количество свободных блоков */
    size_t allocated_blocks;        /* Количество выделенных блоков */
    size_t total_memory;            /* Общий объем памяти в байтах */
    size_t free_memory;             /* Объем свободной памяти в байтах */
    size_t allocated_memory;        /* Объем выделенной памяти в байтах */
    size_t fragmentation_percent;   /* Процент фрагментации */
};
```

### 4. Интерфейс модульных параметров

Модуль должен поддерживать операции через модульные параметры с использованием `module_param_cb`:

| Параметр | Операция | Формат |
|----------|---------|--------|
| `alloc` | Выделить память | Размер в байтах (например: `echo 8192 > /sys/module/kernel_alloc/parameters/alloc`) |
| `free` | Освободить память | Адрес выделенной памяти в виде числа (например: `echo 0xffffc9000c000000 > /sys/module/kernel_alloc/parameters/free`) |
| `stats` | Получить статистику | Вывести статистику аллокатора в формате строки |
| `bitmap_info` | Посмотреть состояние bitmap | Вывести информацию о распределении памяти |

#### Указания к реализации module_param_cb интерфейса

Используйте макрос `module_param_cb()` для создания параметров с callback-функциями.

### 5. Требования к безопасности

- ✅ Корректно обрабатывать ошибки выделения памяти
- ✅ Проверять граничные условия (выделение большего размера чем доступно)
- ✅ Освобождать память при удалении модуля
- ✅ Валидировать входные данные в callback-функциях
- ✅ Отслеживать выделенные блоки и предотвращать двойное освобождение

### 6. Обработка ошибок

Определить и документировать коды возврата:

```c
#define ALLOC_OK        0       /* Операция успешна */
#define ALLOC_NOMEM     -1      /* Недостаточно памяти */
#define ALLOC_INVALID   -2      /* Неверный параметр */
#define ALLOC_NOT_FOUND -3      /* Блок не найден при освобождении */
```

---

## Детали реализации Bitmap

### Структура bitmap

Bitmap хранится как массив `unsigned char` (байтов). Каждый байт содержит 8 бит, где каждый бит представляет состояние одного блока:
- **0** = блок свободен
- **1** = блок занят

---

## Структура проекта

```
kernel_alloc_module/
├── Makefile                 # Главный файл сборки
├── Kbuild                   # Конфигурация сборки модуля
└── src/
    ├── main.c               # Основной код модуля и инициализация
    ├── params.c             # Реализация module_param_cb интерфейса
    ├── allocator.c          # Реализация функций аллокатора
    └── bitmap.c             # Вспомогательные функции работы с bitmap
```

Модуль должен иметь название `kernel_alloc.ko` при сборке.

---

## Пример использования после загрузки модуля

```bash
# Загрузить модуль
sudo insmod kernel_alloc.ko

# Получить текущую статистику
cat /sys/module/kernel_alloc/parameters/stats
# Вывод: Total: 10240 KB | Free: 10240 KB | Allocated: 0 KB | Fragmentation: 0%

# Выделить 8 KiB памяти
echo 8192 > /sys/module/kernel_alloc/parameters/alloc
# Вывод в dmesg: kernel_alloc: allocated 8192 bytes at 0xffffc9000c000000

# Выделить ещё 16 KiB памяти
echo 16384 > /sys/module/kernel_alloc/parameters/alloc
# Вывод в dmesg: kernel_alloc: allocated 16384 bytes at 0xffffc9000c002000

# Получить обновленную статистику
cat /sys/module/kernel_alloc/parameters/stats
# Вывод: Total: 10240 KB | Free: 10216 KB | Allocated: 24 KB | Fragmentation: 0%

# Посмотреть информацию о bitmap
cat /sys/module/kernel_alloc/parameters/bitmap_info
# Вывод: [XX......XX..............................] (визуализация или список занятых блоков)

# Освободить память по адресу
echo 0xffffc9000c000000 > /sys/module/kernel_alloc/parameters/free
# Вывод в dmesg: kernel_alloc: freed memory at 0xffffc9000c000000

# Проверить статистику после освобождения
cat /sys/module/kernel_alloc/parameters/stats
# Вывод: Total: 10240 KB | Free: 10232 KB | Allocated: 8 KB | Fragmentation: 0%

# Выгрузить модуль
sudo rmmod kernel_alloc
```

---

## Формат сдачи

Сдавайте архив со следующей структурой:

```
студент_фамилия_kernel_alloc.tar.gz
├── Makefile
├── Kbuild
└── src/
    ├── main.c
    ├── params.c
    ├── allocator.c
    └── bitmap.c
```

---

## Дополнительные требования

### Обработка граничных случаев
- Выделение 0 байт
- Выделение размера больше доступной памяти
- Освобождение недопустимого адреса
- Выделение после того как память почти полная

### Тестирование
Напишите простой тест-сценарий, который:
1. Выделяет несколько блоков разных размеров
2. Проверяет статистику
3. Освобождает блоки в различном порядке
4. Проверяет статистику после освобождения

---

**Удачи в разработке! Если есть вопросы, обратитесь на консультацию.**
